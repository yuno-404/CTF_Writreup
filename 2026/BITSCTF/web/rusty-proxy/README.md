---
title: 'BITSCTF Web Challenge: rusty-proxy Write-up'

---



---

# BITSCTF Web Challenge: rusty-proxy Write-up

---

## 0. æ¶æ§‹åœ–ï¼šåå‘ä»£ç†ï¼ˆReverse Proxyï¼‰çš„ä¸‰æ–¹é—œä¿‚

åœ¨é€™å€‹æ¶æ§‹ä¸‹ï¼Œ**ä¼ºæœå™¨æ˜¯èº²åœ¨ Proxy å¾Œé¢çš„**ï¼Œç¶²é ï¼ˆä½¿ç”¨è€…ï¼‰çµ•å°ç„¡æ³•ç›´æ¥è·Ÿä¼ºæœå™¨è¬›è©±ã€‚

```text
       (ç¶²éš›ç¶²è·¯ / å…¬é–‹ä¸”å±éšª)                           (å…§éƒ¨ç¶²è·¯ / å°é–‰ä¸”å®‰å…¨)
                                   |
+-------------------+              |              +-------------------+              +-------------------+
|                   |  ç™¼é€è«‹æ±‚    |              |                   |   è½‰ç™¼è«‹æ±‚   |                   |
| ç¶²é  / ç€è¦½å™¨     |  (Request)   |              | Proxy (ä»£ç†ä¼ºæœå™¨)|  (Request)   | Server (å¾Œç«¯ä¼ºæœå™¨)|
| (Client / é¡§å®¢)   | -----------> | -----------> | (å¦‚ rusty-proxy)  | -----------> | (å¦‚ Flask / å»šæˆ¿)  |
|                   |              |              |                   |              |                   |
|                   | <----------- | <----------- | (å®‰å…¨æª¢æŸ¥ã€è² è¼‰å¹³è¡¡)| <----------- | (è™•ç†å•†æ¥­é‚è¼¯ã€DB) |
|                   |  å›å‚³çµæœ    |              |                   |   å›å‚³çµæœ   |                   |
+-------------------+ (Response)   |              +-------------------+  (Response)  +-------------------+
                                   |
                                 é˜²ç«ç‰†
                              (Firewall)

```
* **ç¶²é  (Client)**ï¼šåªçŸ¥é“ Proxy çš„ IPï¼ˆä¾‹å¦‚ `127.0.0.1:8888`ï¼‰ã€‚
* **Proxy**ï¼šç«™åœ¨æœ€å‰ç·šï¼Œè² è²¬æ“‹å­å½ˆã€æª¢æŸ¥è«‹æ±‚æ˜¯å¦åˆæ³•ã€‚å¦‚æœåˆæ³•ï¼Œæ‰è½‰äº¤çµ¦å¾Œç«¯ã€‚
* **Server**ï¼šåœ¨å…§ç¶²ï¼ˆä¾‹å¦‚ `8080` portï¼‰ï¼Œå®ƒåªä¿¡ä»»å¾ Proxy å‚³ééä¾†çš„è³‡æ–™ï¼Œå°ˆå¿ƒåšèœï¼ˆè™•ç†è³‡æ–™ï¼‰ã€‚

---

## 1. é¡Œç›®æ¦‚è¿°

æœ¬é¡Œå±•ç¤ºäº†ä¸€å€‹å…¸å‹çš„ **å­˜å–æ§åˆ¶ç¹éï¼ˆACL Bypassï¼‰** æ¼æ´ã€‚æ¼æ´æ ¹æºæ–¼åå‘ä»£ç†æœå‹™ï¼ˆProxyï¼‰èˆ‡å¾Œç«¯æœå‹™ï¼ˆBackendï¼‰å°æ–¼ HTTP è«‹æ±‚è·¯å¾‘è™•ç†é‚è¼¯çš„ä¸ä¸€è‡´ã€‚
```text
ç›®æ¨™ï¼šé§­å®¢æƒ³å­˜å–å¾Œç«¯çš„æ©Ÿå¯†è·¯å¾‘ /admin/flag
é™åˆ¶ï¼šProxy è¦å®šã€Œåªè¦æ˜¯ä»¥ /admin é–‹é ­çš„è«‹æ±‚ï¼Œä¸€å¾‹é˜»æ“‹ (403)ã€

+----------------+
| é§­å®¢ (Client)  | --- ç™¼é€æƒ¡æ„è«‹æ±‚: GET /%61dmin/flag HTTP/1.1 --->
+----------------+
                                   |
                                   V
                 +-----------------------------------+
                 |        Proxy (ç¬¬ä¸€é“é˜²ç·š)         |
                 |-----------------------------------|
                 | 1. çœ‹åˆ°è·¯å¾‘: /%61dmin/flag        |
                 | 2. é‚è¼¯æª¢æŸ¥: æ˜¯ /admin é–‹é ­å—ï¼Ÿ   |
                 | 3. åˆ¤æ–·: ä¸æ˜¯ï¼(æ”¾è¡Œ âœ…)           |
                 +-----------------------------------+
                                   |
                      (Proxy å°‡åŸå§‹å­—ä¸²åŸå°ä¸å‹•è½‰ç™¼)
                      --- è½‰ç™¼: GET /%61dmin/flag --->
                                   |
                                   V
                 +-----------------------------------+
                 |        Server (å¾Œç«¯æ‡‰ç”¨ç¨‹å¼)      |
                 |-----------------------------------|
                 | 1. æ”¶åˆ°è·¯å¾‘: /%61dmin/flag        |
                 | 2. é è™•ç†: é€²è¡Œ URL è§£ç¢¼ (Decode) |
                 |    (è‡ªå‹•å°‡ %61 é‚„åŸæˆ a)          |
                 | 3. å¯¦éš›è·¯ç”±: /admin/flag          |
                 | 4. åˆ¤æ–·: å‘½ä¸­ç®¡ç†å“¡è·¯ç”±ï¼(åŸ·è¡Œ ğŸš©) |
                 +-----------------------------------+
                                   |
                   <--- å›å‚³æ©Ÿå¯†è³‡æ–™ {"flag": "..."} ---

```
* **Proxy**: ä½¿ç”¨ Rust ç·¨å¯«ï¼Œè² è²¬åˆæ­¥éæ¿¾è«‹æ±‚ï¼Œç›£è½åŸ å£ `8888`ã€‚![image](https://hackmd.io/_uploads/HkPUJcUOZl.png)

* **Backend**: ä½¿ç”¨ Python Flask ç·¨å¯«ï¼Œå…§éƒ¨æœå‹™ï¼Œç›£è½åŸ å£ `8080`ã€‚![image](https://hackmd.io/_uploads/BJZvk9I_-g.png)

* **ç›®æ¨™**: ç¹é Proxy çš„è·¯å¾‘æª¢æŸ¥ï¼Œå­˜å–è¢«ä¿è­·çš„ `/admin/flag` ç«¯é»ã€‚
![image](https://hackmd.io/_uploads/HJ4tk5Uu-l.png)



## 2. ç’°å¢ƒèˆ‡æª”æ¡ˆçµæ§‹

```text
.
â”œâ”€â”€ docker-compose.yml   # å®šç¾©æœå‹™å®¹å™¨èˆ‡ç¶²è·¯æ¶æ§‹
â”œâ”€â”€ proxy/
â”‚   â””â”€â”€ src/main.rs      # Rust Proxy åŸå§‹ç¢¼ï¼ˆæ¼æ´é»ï¼‰
â””â”€â”€ backend/
    â””â”€â”€ server.py        # Flask Backend åŸå§‹ç¢¼ï¼ˆæ•æ„Ÿè³‡æ–™ï¼‰

```

## 3. æ¼æ´åˆ†æï¼šèªç¾©ä¸ä¸€è‡´æ€§ (Semantic Inconsistency)

### 3.1 ä»£ç†ç«¯çš„æª¢æŸ¥é‚è¼¯ (Rust)

åœ¨ `proxy/src/main.rs` ä¸­ï¼ŒACL æª¢æŸ¥å‡½å¼å¦‚ä¸‹ï¼š

```rust
fn is_path_allowed(path: &str) -> bool {
    let normalized = path.to_lowercase();
    if normalized.starts_with("/admin") {
        return false;
    }
    true
}

```

* **å•é¡Œé»**: æ­¤å‡½å¼åƒ…å°‡å­—ä¸²è½‰ç‚ºå°å¯«ï¼Œéš¨å³æª¢æŸ¥æ˜¯å¦ä»¥ `/admin` é–‹é ­ã€‚å®ƒ**æ²’æœ‰è™•ç† URL ç·¨ç¢¼**ï¼ˆå¦‚ `%61`ï¼‰æˆ–**è·¯å¾‘æ­£è¦åŒ–**ï¼ˆå¦‚ `//` æˆ– `./`ï¼‰ã€‚

### 3.2 å¾Œç«¯ç«¯çš„è§£æè¡Œç‚º (Flask)

å¾Œç«¯ Flask æœå‹™åœ¨æ¥æ”¶åˆ°è«‹æ±‚æ™‚ï¼Œæœƒè‡ªå‹•é€²è¡Œ **URL Decoding**ã€‚

* ç•¶ Proxy çœ‹åˆ° `/%61dmin`ï¼šå®ƒèªç‚ºé€™ä¸æ˜¯ä»¥ `/admin` é–‹é ­ï¼Œå› æ­¤æ”¾è¡Œã€‚
* ç•¶ Flask çœ‹åˆ° `/%61dmin`ï¼šå®ƒæœƒè§£ç¢¼æˆ `/admin`ï¼Œä¸¦æˆåŠŸåŒ¹é…åˆ°æ•æ„Ÿè·¯ç”±ã€‚

### 3.3 åŸç†è§£æ
#### ä»£ç†ç«¯ï¼ˆProxyï¼‰çš„ã€Œç›´è¦ºå¼ã€è™•ç†
åœ¨ Rust æ’°å¯«çš„ Proxy ä¸­ï¼Œç¨‹å¼é€šå¸¸æ˜¯ç›´æ¥æ‹¿ HTTP Request Line è£¡çš„åŸå§‹å­—ä¸²ä¾†åšæ¯”å°ã€‚
> Request Line çš„çµæ§‹
æ ¹æ“š RFC æ¨™æº–ï¼ŒRequest Line çš„æ ¼å¼éå¸¸å›ºå®šï¼Œç”±ä¸‰å€‹æ¬„ä½çµ„æˆï¼Œä¸­é–“ä»¥ç©ºç™½åˆ†éš”ï¼š$$\text{Method} \quad \text{Request-Target} \quad \text{HTTP-Version} \quad \text{CRLF}$
ç•¶ä½ åŸ·è¡Œ curl http://127.0.0.1:8888/%61dmin/flag æ™‚ï¼Œé€å‡ºçš„ Request Line æœƒæ˜¯ï¼šGET /%61dmin/flag HTTP/1.1

ç¯„ä¾‹æ¸¬è©¦: curl -v http://localhost:8888/test
![image](https://hackmd.io/_uploads/rkoWW98_Wg.png)

é€™å°±æ˜¯ç‚ºä»€éº¼é€™é¡Œæœƒå‡ºäº‹çš„åŸå› ï¼
1. Proxy æ¥æ”¶è«‹æ±‚ï¼šRust Proxy æ”¶åˆ°é€™ä¸²åŸå§‹æ–‡å­— GET /%61dmin/flag HTTP/1.1ã€‚
1. è§£æ Request Lineï¼šProxy æœƒå»åˆ‡åˆ†é€™è¡Œå­—ä¸²ã€‚å®ƒçœ‹åˆ° Request-Target æ˜¯ /%61dmin/flagã€‚
1. ç›´æ¥æ¯”å°ï¼šProxy çš„ç¨‹å¼ç¢¼ï¼ˆå¦‚ä¸‹ï¼‰ç›´æ¥æ‹¿é€™å€‹ã€ŒåŸå§‹å­—ä¸²ã€å»æ¯”å°ï¼š
```
// å®ƒçœ‹åˆ°çš„ path å°±æ˜¯ "/%61dmin/flag"
if path.starts_with("/admin") { ... }
```
å°å­—ä¸²ä¾†èªªï¼Œ/% é–‹é ­ç•¶ç„¶ä¸ç­‰æ–¼ /a é–‹é ­ï¼Œæ‰€ä»¥å®‰å…¨éé—œã€‚

#### å¾Œç«¯ï¼ˆFlask/Werkzeugï¼‰çš„ã€Œæ¨™æº–åŒ–ã€æµç¨‹
ç•¶è«‹æ±‚åˆ°é” Flask æ™‚ï¼Œå®ƒä¸¦ä¸æ˜¯ç›´æ¥æ‹¿åŸå§‹å­—ä¸²å»åŒ¹é…è·¯ç”±ï¼Œè€Œæ˜¯æœƒç¶“éä¸€å€‹ Normalizationï¼ˆæ­£è¦åŒ–ï¼‰ çš„éç¨‹ã€‚

Flask åº•å±¤ä½¿ç”¨çš„æ˜¯ Werkzeug å‡½å¼åº«ï¼Œå®ƒåœ¨é€²è¡Œè·¯ç”±åŒ¹é…ï¼ˆRoute Matchingï¼‰å‰æœƒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š
1. URL Decodingï¼šå°‡æ‰€æœ‰ %XX æ ¼å¼çš„ç·¨ç¢¼é‚„åŸã€‚%61 $\rightarrow$ aã€‚
1. Path Foldingï¼šè™•ç†å¤šé¤˜çš„æ–œç·šï¼ˆå¦‚ // $\rightarrow$ /ï¼‰æˆ–é»è™Ÿè·¯å¾‘ï¼ˆå¦‚ /./ï¼‰ã€‚
1. Encoding Conversionï¼šç¢ºä¿è·¯å¾‘ç¬¦åˆæ‡‰ç”¨ç¨‹å¼é æœŸçš„ç·¨ç¢¼ã€‚

å› æ­¤ï¼Œåœ¨ Flask å…§éƒ¨çš„è·¯ç”±è¡¨ï¼ˆRouterï¼‰çœ‹ä¾†ï¼Œå®ƒæ”¶åˆ°çš„è¼¸å…¥å·²ç¶“è®Šæˆäº† /admin/flagï¼Œè‡ªç„¶æœƒè§¸ç™¼å°æ‡‰çš„è™•ç†å‡½å¼ã€‚

---

## 4. æ¼æ´åˆ©ç”¨ (Exploitation)

### 4.1 æ”»æ“Šæ€è·¯

åˆ©ç”¨ç™¾åˆ†æ¯”ç·¨ç¢¼ï¼ˆPercent-encodingï¼‰ä¾†æ¬ºé¨™ Proxy çš„å­—ä¸²æ¯”å°é‚è¼¯ã€‚

### 4.2 åŸ·è¡Œ Exploit

ä½¿ç”¨ `curl` é€²è¡Œæ¸¬è©¦ï¼Œæ³¨æ„å¿…é ˆåŠ ä¸Š `--path-as-is` ä»¥é˜²æ­¢å®¢æˆ¶ç«¯å…ˆå°è·¯å¾‘é€²è¡Œé è™•ç†ã€‚
> --path-as-is æ˜¯ curl çš„ä¸€å€‹é¸é …ï¼Œæ„æ€æ˜¯ï¼š
> - ä¸è¦å¹«ä½ ã€Œä¿®æ­£/æ­£è¦åŒ–ã€URL è·¯å¾‘
> - æŠŠä½ å¯«çš„ path å¹¾ä¹åŸå°ä¸å‹•é€å‡ºå»

```bash
# æ ¸å¿ƒ Payload: å°‡ 'a' ç·¨ç¢¼ç‚º %61
curl -i --path-as-is http://127.0.0.1:8888/%61dmin/flag

```


**é æœŸå›æ‡‰:**

```json
{
  "flag": "BITSCTF{p4th_n0rmalizati0n_is_tricky_in_rust}"
}

```

---

## 5. å½±éŸ¿èˆ‡é˜²ç¦¦å»ºè­°

### 5.1 æ¼æ´ç­‰ç´šï¼š<span style="color:red">Critical</span>

æ”»æ“Šè€…å¯å®Œå…¨ç¹éç¬¬ä¸€å±¤é˜²ç·šï¼Œå­˜å–å¾Œç«¯å—ä¿è­·çš„è¡Œæ”¿ç®¡ç†åŠŸèƒ½æˆ–æ•æ„Ÿè³‡è¨Šã€‚

### 5.2 ä¿®è£œæ–¹æ¡ˆ

1. **å…ˆè§£ç¢¼å¾Œæª¢æŸ¥**: åœ¨é€²è¡Œ `starts_with` æª¢æŸ¥å‰ï¼Œæ‡‰å…ˆå° path é€²è¡Œ URL Decodeã€‚
2. **æ¨™æº–åŒ–è·¯å¾‘**: ä½¿ç”¨ç¾æˆçš„å‡½å¼åº«è™•ç†è·¯å¾‘ï¼ˆä¾‹å¦‚ç§»é™¤å¤šé¤˜çš„æ–œç·šã€è™•ç† `../`ï¼‰ã€‚
3. **é˜²ç¦¦æ·±åº¦ (Defense in Depth)**: å¾Œç«¯æœå‹™ä¸æ‡‰å®Œå…¨ä¾è³´ Proxy çš„å®‰å…¨æª¢æŸ¥ï¼Œè‡ªèº«ä¹Ÿæ‡‰å¯¦ä½œèº«åˆ†é©—è­‰æ©Ÿåˆ¶ã€‚

### 5.3 ä¿®å¾©ç¨‹å¼ç¢¼
- åœ¨ proxy/src/main.rs:63 åŠ äº† from_hex_digit
  - åšä»€éº¼ï¼šæŠŠ %xx çš„ hex å­—å…ƒè½‰æˆæ•¸å€¼ã€‚
  - ç›®çš„ï¼šæ”¯æ´å¾Œé¢åš´æ ¼ URL decodeã€‚
![image](https://hackmd.io/_uploads/Hyyi4q8Obe.png)

- åœ¨ proxy/src/main.rs:72 åŠ äº† strict_percent_decode
  - åšä»€éº¼ï¼šå° path åšåš´æ ¼ percent-decodingï¼ˆ%61 -> aï¼‰ã€‚
  - é˜²ç¦¦é»ï¼š
    - éæ³•ç·¨ç¢¼ï¼ˆåƒ %ZZã€ä¸å®Œæ•´ %ï¼‰ç›´æ¥å ±éŒ¯ã€‚
    - decode å¾Œä¸æ˜¯åˆæ³• UTF-8 ä¹Ÿå ±éŒ¯ã€‚
  - æ•ˆæœï¼šé¿å…ã€Œå¥‡å½¢æ€ªç‹€ç·¨ç¢¼ã€è¢«ç•¶æ­£å¸¸è·¯å¾‘æ”¾è¡Œã€‚
![image](https://hackmd.io/_uploads/ByTnNcLuZe.png)

- åœ¨ proxy/src/main.rs:96 åŠ äº† normalize_path_for_acl
  - åšä»€éº¼ï¼šæŠŠ ACL ç”¨çš„è·¯å¾‘å…ˆçµ±ä¸€æˆ canonical formï¼š
    - å»æ‰ query/fragmentï¼ˆACL åªçœ‹ pathï¼‰
    - é™åˆ¶ request-target å¿…é ˆæ˜¯ /...ï¼ˆorigin-formï¼‰
    - æ‹’çµ• \ èˆ‡æ§åˆ¶å­—å…ƒ
    - è™•ç† .ã€..ã€é‡è¤‡ /
    - æœ€å¾Œè½‰å°å¯«
  - æ•ˆæœï¼šå‰å¾Œç«¯çœ‹åˆ°çš„è·¯å¾‘èªç¾©æ›´ä¸€è‡´ï¼Œé™ä½ parser/normalization mismatchã€‚
![image](https://hackmd.io/_uploads/HydRE58uZl.png)

- åœ¨ proxy/src/main.rs:280 æ”¹å¯« is_path_allowed
  - åšä»€éº¼ï¼šä¸å†ç›´æ¥ starts_with("/admin") æ¯” raw pathï¼›
    æ”¹æˆæ¯”å° normalize å¾Œçš„ pathï¼š
    - æ“‹ "/admin"
    - æ“‹ "/admin/*"
  - æ•ˆæœï¼š/%61dmin/flag æœƒå…ˆè®Šæˆ /admin/flagï¼Œå› æ­¤è¢«æ­£ç¢ºæ“‹ä¸‹ï¼ˆ403ï¼‰ã€‚
![image](https://hackmd.io/_uploads/ByFWHqIdbe.png)

- åœ¨ proxy/src/main.rs:558 æ›´æ–° handle_client çš„ ACL åˆ†æ”¯
  - åšä»€éº¼ï¼š
    - è¦å‰‡å‘½ä¸­ï¼ˆçœŸçš„ä¸å…è¨±ï¼‰å› 403
    - è·¯å¾‘æ ¼å¼/ç·¨ç¢¼éŒ¯èª¤å› 400
  - æ•ˆæœï¼šæŠŠã€Œæƒ¡æ„ç¹éã€å’Œã€Œæ ¼å¼éŒ¯èª¤ã€åˆ†é–‹ï¼Œè¡Œç‚ºæ›´æ¸…æ¥šä¹Ÿæ›´å®‰å…¨ã€‚
![image](https://hackmd.io/_uploads/H1ZPB9IuWe.png)

---


## è£œå……è³‡è¨Š  
{%preview https://www.youtube.com/watch?v=voTHFdL9S2k %}

